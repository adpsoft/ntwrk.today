---
layout: post
title: "Опыт построения DPI IP/ECMP based фабрики на оборудовании Juniper QFX10k с применением symmetric hashing"
tags: juniper qfx mpls bgp evpn l3vpn vxlan dpi ips hash hashing symmetric resilient
author: "somovis"
---

В данной заметке я хочу поделится опытом построения DPI блока сети передачи данных (PoD) граничащего с EVPN/VXLAN фабрикой на оборудовании **Juniper QFX10k** с применением **IP/ECMP, symmetric hashing, resilient hashing**.

## Вступление
Порой встречаются довольно интересные задачи, вот так и мне однажды посчастливилось, когда нам понадобилось построить для защиты определенного сегмента сети и его сертификации DPI блок с применением IPS. Не буду вдаваться в подробности на этом моменте, нас же больше интересует техническое решение задачи.

*Сразу хочу обратить твое внимание, уважаемый читатель, что данное техническое решение прорабатывалось в начале 2020 года, а схема тестировалась на разных платформах и моделях разных производителей, но сейчас уже появилось более дешевое/новое оборудование или обновление ПО для более дешевого оборудования того же производителя, которое так же подходит для решения данной задачи.*

ТЗ было примерно следующим:
* Цель ~500Гбит;
* Наличие резервирования;
* Сертифицированное ФСТЭК оборудование;
* Потенциальный рост - проработать масштабирование;
* Универсальный дизайн DPI блока СПД для возможности применения различного оборудования DPI в случае масштабирования - все же конкурентные закупки;
* Удешевить решение.

## Размышления
Если говорить про техническое решение и посмотреть в корень задачи, то можно увидеть, что требуется IPS на ~500Гбит, резервирование и потенциальный рост.

При этом, исходя из своего опыта, общения с коллегами, знакомыми и производителями, могу сказать, что для решения данной задачи не так уж много производителей подходит. Я не буду их перечислять, но хочу акцентировать внимание на проблему, почему так важно, что используется IPS и почему бы не сделать большой кластер или не поставить два устройства размером с шкаф:
* У производителя X можно собрать кластер до 8-16 устройств, но, при этом, **трафик предназначенный IPS движку обрабатывает только одно устройство** в кластере;
* У производителя Y можно собрать кластер до 8/16 устройств, но, при этом, **результат работы IPS движка не синхронизируется** между устройствами в кластере и в зависимости от платформы получаем либо дроп трафика, либо пропуск трафика (зачем тогда вообще IPS?!);
* У производителя Z можно собрать кластер используя до 2 устройств, при этом, результат работы IPS движка синхронизируется, но **максимальная производительность одного такого устройства на IPS составляет ~800Гбит и имеет довольно высокую цену** для покупки сразу обоих устройств в комплектации с целью на ~500Гбит (помним про резервирование).

Поэтому, я не долго думая, предложил использовать 3 ключевых технологии и отсутствие кластеризации DPI устройств:
1. IP/ECMP - в сравнении с MC-LAG, это позволит сэкономить количество интерфейсов (убираем ICL), отсутствие L2 и slow protocols, наличие гибкого управления трафиком, горизонтальное масштабирование;
2. symmetric hashing - для управления прохождением трафика в оба направления через одно и то же DPI устройство;
3. resilient hashing - для предотвращение перебалансировки всего трафика при аварии одного (или более) DPI устройства.


## Масштабирование
Если говорить про выбор того или иного решения, то это всегда компромиссы, поэтому, ниже я опишу различные варианты масштабирования, а так же их плюсы и минусы, примеряя их на нашу задачу.

### заядлый инжиниринг


### scale-up


### scale-out


#### MC-LAG

#### ECMP

## Проблемы


## Конфигурация


## Заключение
С улыбкой и болью вспоминаю фразу из притчи "о доверии (вендорам)" Марата Сибгатулина с linkmeetup: "**на интеграционные тесты вендора не полагайся - сам организуй синтетические и продуктивные тесты.**".

Что бы тебе не говорил тот или иной производитель, какие-бы заключения самостоятельного тестирования не показывал, всегда могут найтись отклонения в ревизии hardware, в различном software, ошибках в software, в наличии включенных и/или выключенных тех или иных особенностях, которые могут напрямую влиять на исполнение решения поставленной задачи, поэтому, собирать лабораторную среду, даже для синтетических тестов, нужно 1:1, как планируется сделать в продуктивной среде.

## Благодарности
Спасибо name1 за вычитку и правки

## Ссылки
<b id="f1">1</b>. [Отличный доклад Игоря Васильева про балансировку трафика](https://www.youtube.com/watch?v=iZavvatyDb8) [↩](#a1)<br/>
<b id="f2">2</b>. [Замечательная статья Марата Сибгатулина про дизайн сетей в ДЦ](https://linkmeup.ru/blog/1261/) [↩](#a2)<br/>
